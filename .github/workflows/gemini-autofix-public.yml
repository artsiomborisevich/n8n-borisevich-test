name: üõ†Ô∏è Gemini Public Gradle Autofix

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * 1'

permissions:
  contents: write
  pull-requests: write

jobs:
  gemini-autofix:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï Setup Java and Gradle
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: üîí Grant Execute Permission to gradlew
        run: chmod +x ./gradlew

      - name: ü§ñ Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: üöÄ Run Gemini Autonomous Fix
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Define Branch and Checkout
          BRANCH_NAME="gemini-autofix-$(date +%Y%m%d%H%M)"
          git checkout -b $BRANCH_NAME
          
          # 2. Instruct the Gemini agent to perform the task
          gemini --yolo --allowed-tools run_shell_command -m gemini-2.5-flash-lite "
            You are a skilled Java/Gradle/Spring Boot developer agent.
          
            **MISSION CRITICAL PROTOCOL:**
            You are FORBIDDEN from committing any code until you have verified the build passes. Follow these steps strictly in order:

            1. **PHASE 1: INSPECTION**
               - Run 'read_file build.gradle' to check the Spring Boot version.
          
            2. **PHASE 2: UPGRADE STRATEGY**
               - **Spring Boot:** Update to latest stable 
               - **General:** Check other standard libraries (Lombok, Jackson, etc.) and update them if they appear outdated.         
          
            3. **PHASE 3: UPGRADE & REFACTOR**
               - Update deprecated usages/methods

            4. **PHASE 4: THE GATEKEEPER (VERIFICATION)**
               - Run the command: **'./gradlew clean build'**
               - **READ THE OUTPUT.**
               - **IF BUILD FAILS:** You are PROHIBITED from committing. You must:
                 - Analyze the error log.
                 - Read the failing test file.
                 - Fix the compilation error or test failure.
                 - **LOOP:** Run './gradlew clean build' again. Repeat until it passes.

            5. **PHASE 5: COMMIT**
               - ONLY after the build prints 'BUILD SUCCESSFUL', commit the changes with message: 'feat: Upgrade to Spring Boot 3.4 and migrate to @MockitoBean'.
            "
          
          # 3. Check for changes, push, and create PR (rest of script remains the same)
          if [ -n "$(git status --porcelain)" ]; then
            echo "Changes found. Committing and pushing."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "feat: Automated Java/Gradle updates by Gemini Agent"
            git push origin $BRANCH_NAME
          
            # Install the GitHub CLI for creating the PR
            sudo apt-get update && sudo apt-get install gh -y
          
            # Create a Pull Request
            gh pr create \
              --base main \
              --head $BRANCH_NAME \
              --title "ü§ñ Automated Fix: Dependency & Deprecation Updates (Gradle)" \
              --body "Gemini Agent has automatically updated dependencies to fix vulnerabilities and refactored deprecated methods. Please review these changes."
          else
            echo "No fixes required or changes detected. Branch not pushed."
          fi